%% Initialisation
clear all; close all; clc;
addpath(genpath('./utils')); addpath(genpath('./plot_functions'));

%% Loading the data
data_to_load = "kin8nm"; %"shalegas" "drawing" "genfct" "kin8nm" <- REAL DATASET
crossValid = true;

%% Selecting the method :
method = "GMR"; %"GMR","GPR"

if (strcmp(data_to_load, "shalegas"))
    data = load('../dataset/shalegas_data.csv');
    fid = fopen('../dataset/shalegas_header.csv');
    header = textscan(fid,'%s%s%s%s%s%s%s%s%s%s%s%s%s','Delimiter',',');
    fclose(fid);
    celldisp(header);
    X_index = false(1, numel(header));
    Y_index = false(1, numel(header));
    for i=1:numel(header)
        X_index(i) = strcmp(header{i}{1}, 'Bakken (ND-MT)');% || ...
                       %strcmp(header{i}{1}, 'Barnett (TX)');
        Y_index(i) = strcmp(header{i}{1}, 'Permian (TX-NM)') ;%|| ...
                       %strcmp(header{i}{1}, 'Barnett (TX)');
    end
    X = data(:, X_index);
    Y = data(:, Y_index);
elseif (strcmp(data_to_load, "drawing"))
    limits = [-50 50 -50 50];
    data = ml_generate_mouse_data(limits, 'labels');
    close;
    
    X = data(1,:)';
    Y = data(2,:)';
elseif(strcmp(data_to_load, "kin8nm"))
    T = readtable('../dataset/kin8nm.csv', 'HeaderLines',0); 
    M=table2array(T);
    M=M(:,:);
    X=M(:,[1:8]); % X: theta i=1..8 joint pos
    Y=M(:,9); %y is column 9
elseif (strcmp(data_to_load, "genfct"))
    data =load('genfct.csv');
    X = data(:,1);
    Y = data(:,2);
end

%normalising the data
Y = Y - mean(Y);

validSize = 0.3; % test/target ratio (inverse than usual)
[X_train, Y_train, X_test, Y_test] = split_data(X, Y, validSize);


if (size(X, 2)+size(Y, 2)<=2)
    figure();
    title('Data','FontSize',20);
    x_grid = [min(X)-1:0.1:max(X)+1];
    scatter(X_train, Y_train, 'g');
    hold on;
    if(~isempty(X_test))
        scatter(X_test, Y_test, 'r');
        legend('Train data','Test data','FontSize',16);
    else
        legend('Train data','FontSize',16);
    end
elseif (size(X, 2)+size(Y, 2)<=3)
    figure();
    title('Data','FontSize',20);
    scatter3(X_train(:, 1), X_train(:, 2), Y_train, 'g');
    hold on;
    if(~isempty(X_test))
        scatter3(X_test(:, 1), X_test(:, 2), Y_test, 'r');
        legend('Train data','Test data','FontSize',16);
    else
        legend('Train data','FontSize',16);
    end
end

%% GPR
if strcmp(method, "GPR")
    %parameters :
    noise_level = 0.1;
    kernel_width = 1;
    kernel_type = 'squaredexponential';

    gprMdl = fitrgp(X_train, Y_train,'FitMethod', 'none', 'BasisFunction','none',...
    'Sigma', noise_level, 'ConstantSigma', true, 'KernelFunction', kernel_type, ...
    'KernelParameters', [kernel_width; 1], 'OptimizeHyperparameters', 'none');
    
    if (size(X, 2)+size(Y, 2)<=2)
        [y_pred,~,y_int] = predict(gprMdl,x_grid');
        figure();
        plot(X_train,Y_train,'g.', 'MarkerSize', 25);
        hold on
        if(~isempty(X_test))
            plot(X_test,Y_test,'c.', 'MarkerSize', 25);
        end
        plot(x_grid,y_pred,'b');
        plot(x_grid, y_int(:,2), '--k')
        plot(x_grid, y_int(:,1), '--k')
        xlabel('x', 'FontSize',18);
        ylabel('y', 'FontSize',18);
        if(~isempty(X_test))
            legend('train data', 'test data','Fit', '95% confidence interval',  'FontSize',16);
        else
            legend('train data', 'Fit', '95% confidence interval',  'FontSize',16);
        end
        title(['GPR - RBF kernel with $\sigma$ = ', num2str(noise_level),...
               ' and $l$ = ', num2str(kernel_width)], 'FontSize',20, 'Interpreter', 'latex');
        hold off
    end
    GPR_loss = loss(gprMdl,X,Y);
end

%% GMR
if strcmp(method, "GMR")
    Xi = [X_train, Y_train]';
    params.cov_type = 'full';
    params.k = 7;
    params.max_iter_init = 100;
    params.max_iter = 500;
    params.d_type = 'L2';
    params.init = 'plus';

    % Run GMM-EM function, estimates the paramaters by maximizing loglik
    [Priors, Mu, Sigma] = gmmEM(Xi, params);
    
    
    N = size(X,2); P = size(Y,2); 
    in  = 1:N;
    out = N+1:(N+P);
    
    if (size(X, 2)+size(Y, 2)<=2)
        plot_gmm(Xi, Priors, Mu, Sigma, params, 'Final Estimates for EM-GMM');
        [y_pred, var_est] = gmr(Priors, Mu, Sigma, x_grid, in, out);
        var_est = squeeze(var_est);
        figure();
        plot(X_train,Y_train,'g.', 'MarkerSize', 25);
        hold on
        if(~isempty(X_test))
            plot(X_test,Y_test,'r.', 'MarkerSize', 25);
        end
        plot(x_grid, y_pred,'k', 'LineWidth', 2);
        plot(x_grid, y_pred+var_est', '--k', 'LineWidth', 3)
        plot(x_grid, y_pred-var_est', '--k', 'LineWidth', 3)
        xlabel('x', 'FontSize',18);
        ylabel('y', 'FontSize',18);
        if(~isempty(X_test))
            l = legend('train data', 'test data','Fit', 'var estimates', 'FontSize',18);
        else
            l = legend('train data','Fit', 'var estimates', 'FontSize',18);
        end
        
        title(['GMR - $ ', params.cov_type, ' covariance - ', 'and ' num2str(params.k),...
               ' components'], 'FontSize',20,'Interpreter', 'latex')
        hold off
    end
    [y_pred, var_est] = gmr(Priors, Mu, Sigma, X', in, out);
    GMR_loss = 1/length(y_pred)*norm(y_pred-Y, 2);

    [AIC, BIC] = gmm_metrics(Xi,Priors,Mu,Sigma,params.cov_type);
   
end
%% 

if strcmp(method, "GMR") && crossValid
    % Cross-validation parameters
    valid_ratio  = 0.5;    % train/test ratio
    k_range   = 5:13;   % range of K to evaluate
    F_fold    = 8;     % # of Folds for cv

    % Compute F-fold cross-validation
    [metrics] = cross_validation_gmr(X', Y', F_fold, valid_ratio, k_range, params);

    plot_gmr_cross_validation(metrics, k_range)
    
elseif strcmp(method, "GPR") && crossValid
    %paramsM.kernel_width = 1.0;
    %paramsM.noise_level = [0.01,0.1,0.5,1.0];
    paramsM.noise_level = 0.1;
    paramsM.noiseCV = false; % ne pas changer, en test
    paramsM.kernel_width = [0.1, 0.5, 1.0, 2.0, 5.0, 10.0];
    paramsM.kernel_type = 'squaredexponential';
    paramsM.useLogScale = true;
    
    F_fold    = 10;     % # of Folds for cv
    valid_ratio  = 0.5;    % train/test ratio

    % plot inside
    metrics = cross_validation_gpr( X', Y', F_fold, valid_ratio, paramsM , false); 
end

% pour tester la qualité de la prédiction avec un testing set sans faire de
% cross validation
if(~isempty(X_test)) 
    if strcmp(method, "GMR")
        [Y_test_est, ~] = gmr(Priors, Mu, Sigma, X_test, in, out);
    elseif strcmp(method, "GPR")
        Y_test_est = predict(gprMdl, X_test);
    end
    [MSE, NMSE, R2] = regression_metrics(Y_test_est',Y_test');
    fprintf('RSQUARED = %.5f\n', R2);
end